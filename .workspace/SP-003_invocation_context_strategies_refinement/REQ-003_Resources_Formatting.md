# REQ-003: Форматирование ресурсов (RESOURCE) в Invocation Context

**Версия:** 1.0  
**Создано:** 2025-12-18  
**Обновлено:** 2025-12-18  
**Спринт:** SP-003

---

## 1. Цель

Улучшить семантическую структуру контекста, передаваемого LLM, путем явного выделения содержимого ресурсов (типа `RESOURCE`) с помощью markdown-разметки. Это позволит модели лучше отличать «сырые» данные и онтологии от инструкций и метаданных.

---

## 2. Функциональные требования

### 2.1 Markdown-оборачивание ресурсов
Все части контекста (фреймы), формируемые из объектов `PromptModule` с типом `RESOURCE`, должны быть представлены в виде кодового блока markdown.

#### 2.1.1 Идентификация типа RESOURCE
Система должна проверять атрибут `type` объекта `PromptModule`. Оборачиванию подлежат только модули с типом `RESOURCE`.
> [!NOTE]
> Модули типов `OPERATOR`, `MODIFIER` и др. (которые обычно являются структурированными YAML-файлами с внутренним ID) оборачиваться в markdown-блоки **не должны**.

#### 2.1.2 Формирование тега языка (Language Tag)
В качестве идентификатора языка (следующего сразу за открывающими кавычками ```) должен использоваться полный `id` ресурса.
> [!IMPORTANT]
> Для ресурсов, загруженных из файлов без внутреннего `id`, загрузчик генерирует `id` на основе пути и имени файла с расширением. Именно этот полный идентификатор (например, `dcl-god-mode/knowledges/ontology/dcl-god-mode.ttl`) должен стать тегом языка.

### 2.2 Поддержка во всех стратегиях
Требование применимо к обеим текущим стратегиям сборки контекста:
- `GeminiNativeStrategy`
- `ConcatenationStrategy`

#### 2.2.1 GeminiNativeStrategy
В данной стратегии каждый ресурс представлен отдельным `TextFrame`. Содержимое `TextFrame` для ресурса должно быть сформировано как markdown-блок.

#### 2.2.2 ConcatenationStrategy
В данной стратегии все содержимое объединяется в один `TextFrame`. Секции, относящиеся к ресурсам (выводимые через `_format_module`), должны содержать markdown-оборачивание.

---

## 3. Нефункциональные требования

- **Надежность:** Если содержимое ресурса уже содержит markdown-блоки, стратегия должна корректно обрабатывать вложенность (использовать большее количество обратных кавычек).
- **Консистентность:** Правила форматирования должны быть идентичны во всех компонентах системы.

---

## 4. Критерии приемки

1. В выводе `Invocation Context` для ресурсов (например, онтологий `.ttl`) текст обернут в ``` [bundle/path/to/file.ext] ... ```.
2. Для операторов текст остается без markdown-оборачивания.
3. Изменения реализованы в `GeminiNativeStrategy` и `ConcatenationStrategy`.
4. Визуальная проверка через `verify_agent_real.py` подтверждает наличие разметки в `Frame N`.

---

## 5. Открытые вопросы

Нет.

---

## 6. Ссылки

- Базовые требования: [REQ-001 v1.0](file:///c:/git/dcl/.workspace/SP-001_dcl_agent_implementation/REQ-001_DCL%20Agent.md)
- Рамки (Scope): [SCOPE-003](file:///C:/Users/eerem/.gemini/antigravity/brain/e4c2ca5c-e6b5-45d5-8be8-e9362d1af4aa/00_SCOPE.md)

---

## История версий

| Версия | Дата | Изменения |
|---------|------|---------|
| 1.0 | 2025-12-18 | Начальные требования для SPI-003 |
