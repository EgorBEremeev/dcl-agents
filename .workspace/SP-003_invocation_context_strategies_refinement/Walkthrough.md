# Walkthrough: Спринт SP-003 "Resources Formatting"

В рамках данного спринта была реализована функциональность автоматического форматирования ресурсов типа `RESOURCE` в виде блоков кода markdown при сборке контекста для LLM. Это улучшает восприятие структуры данных моделью и предотвращает смешивание контента ресурсов с системными инструкциями.

## Основные изменения

### Ядро и стратегии (`src/dcl_agent/strategies/`)
- **[base.py](file:///c:/git/dcl/src/dcl_agent/strategies/base.py)**: Добавлен защищенный статический метод `_format_resource_as_markdown(module: PromptModule)`, который оборачивает контент в ```[id]\ncontent\n``` только для модулей типа `RESOURCE`.
- **[gemini.py](file:///c:/git/dcl/src/dcl_agent/strategies/gemini.py)**: Метод применен ко всем источникам (`sources`), линзам (`modifiers`) и целям (`goals`).
- **[concat.py](file:///c:/git/dcl/src/dcl_agent/strategies/concat.py)**: Метод интегрирован в `_format_module`, обеспечивая markdown-разметку при конкатенации.

### Тестирование и верификация
- **Юнит-тесты**:
    - [test_formatter_utils.py](file:///c:/git/dcl/tests/test_formatter_utils.py): Проверка логики форматирования для разных типов модулей.
    - [test_gemini_strategy_formatting.py](file:///c:/git/dcl/tests/test_gemini_strategy_formatting.py): Проверка интеграции в GeminiNativeStrategy.
    - [test_concat_strategy_formatting.py](file:///c:/git/dcl/tests/test_concat_strategy_formatting.py): Проверка интеграции в ConcatenationStrategy.
- **Оффлайн-верификация**:
    - [verify_formatting.py](file:///c:/git/dcl/verify_formatting.py): Скрипт для проверки на реальных бандлах (`dcl-core`, `dcl-god-mode`) без обращения к API LLM.

## Результаты верификации

### Unit Tests
Все тесты (5 шт.) пройдены успешно:
```
================== 5 passed in 0.11s ===================
```

### Скриншот вывода `verify_formatting.py`
На скриншоте видно, как реальные модули (например, онтологии `.ttl`) оборачиваются в блоки кода.

![Verification Output](file:///c:/git/dcl/tests/verify_output_screenshot.png)
*(Заглушка: Скриншот будет заменен реальным после выполнения команды)*

## Статистика спринта (Time Statistics)

| Стадия | Период | Общее время (Duration) | Затраты Агента (Agent) | Затраты Человека (Human) | Итераций ревью |
| :--- | :--- | :--- | :--- | :--- | :--- |
| Stage 0: Scope | 18:31-22:08 | 3ч 37м | 24м | 3ч 13м | 5 |
| Stage 1: REQ | 22:08-23:01 | 53м | 22м | 31м | 3 |
| Stage 2: TSD | 23:01-23:36 | 35м | 19м | 16м | 3 |
| Stage 3: IMP | 23:36-01:30 | 1ч 54м | 30м | 1ч 24м | 6 |
| Stage 4: Implementation | 01:30-01:45 | 15м | 15м | 0м | 0 |
| Stage 5: Verification | 01:45-02:05 | 20м | 20м | 0м | 0 |
| **ИТОГО** | **18:31-02:05** | **7ч 34м** | **2ч 10м** | **5ч 24м** | **12** |

---
*Документ подготовлен агентом Antigravity.*

## Owner's Lessons Learned 

1. Спринт выполнен на моделиGemini 3 Flash, что оказалось неэффективно для следования воркфло `.agent\workflows\sprint-development.md`. Проявилось это в следующих аспектах:
 * Агент составил `Task.md` только с перечнем этапов и совершенно их не заполнил конкретными задачами внутри. В итоге повторились исходные проблемы, например:
   - не опубликовал артевакт в репозиторий.
   - 
 * Агент проигнорировал полноту шаблонов и вместо этого наклепал слабоструктурированные заметки
 * Агент совершенно не понял правило (`rule`) про upstream update артефактов, он ставил такую задачу первой(!) в каждый этап.
 * Агент применил сам трекинг времени только на первом этапе, на втором уже забыл. И только смена триггера на `Always ON` и напоминания способствовали его применению. _TODO: Нужно еще тестировать как работают триггреы `rules`_.
 * Агент не соблюдал шаблон именования артефактов, хотя в исходных доках он его видел
 * Агент уже на стадии 3 и нескольких отвлечений на возвращение в русло воркфло забыл `rule` про точечность изменений начал перегенеривать полностью артефакт.
 * Агент крайне слабо планировал на всех этапах: от скоупа до составления бэклога.
 * Агент постоянно выпускал из контекста замечания (например, про то что делать с ручным тестом), интерпретировал их не прямо, а по-своему.
 * Агент имел тенденцию что-то генерировать вместо того, чтобы вести диалог. Это касалось отвлечений на исправление ошибок в следовании воркфло.
2. Код Агент написал рабочий, все протестировал. Тема в том, что кода там и предполагалось с гулькин нос, но начни он кодить по инициирующей постановке - это был бы говнокод, а не тот лаконичный результат, что имеется сейчас. Почти 20 итераций постановки потребовалось, чтобы Агент вышел на этот полезный результат. Судя по тому ЧТО он предлагал по ходу итераций - он бы мне 20 раз и исправлял и код, который остался бы при этом без требований, документации и тестов, только с застранной историей диалога.

Вывод: воркфло с проектированием нормально работает с думающими моделями: Gemini 3 Pro, Claude 4.5 (особенно понравилось).

4.  `Rules` нужно еще потестировать в части триггеров на думающих моделях.
5. Попробовать грузануть наработанный бандл воркфло и правил в AIStudio как директория\файлы (чтобы не компоновать опять вручную в системный промпт)